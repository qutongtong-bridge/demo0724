# 領収書発行機能設計書

## 概要

領収書発行機能により、ユーザーは充電サービス終了後に領収書の宛名情報を入力し、電子領収書を生成でき、経費精算や記録管理を容易にします。

## ページデザイン

### ページタイトル
- 「領収書発行」
- 左上に戻るボタン

### メインコンテンツエリア

#### 1. 機能説明
- **説明テキスト**：
  - 「領収書の宛名を入力して「発行する」ボタンを押してください。」

#### 2. 入力エリア
- **入力フィールドラベル**：「宛名」
- **入力フィールド**：
  - プレースホルダーテキスト表示
  - テキスト入力をサポート
  - 白い背景
  - 角丸ボーダーデザイン

#### 3. アクションボタン
- **発行ボタン**：
  - テキスト：「宛名なしで発行する」
  - オレンジ背景（#FF6B35）
  - 白いテキスト
  - 角丸ボタンデザイン
  - 入力フィールドの下に配置

### キーボードインタラクション
- 入力フィールドをタップすると自動的にキーボードが表示
- 日本語入力メソッドをサポート
- キーボードタイプ：テキストキーボード
- 完了ボタン：「完了」

## インタラクションフロー

### 1. 基本フロー
1. ユーザーが充電完了ページから「領収書を発行する」リンクをクリック
2. 領収書発行ページに入る
3. ユーザーは選択可能：
   - 領収書の宛名を入力
   - 直接「宛名なしで発行する」をクリック
4. システムが電子領収書を生成
5. ダウンロードまたは共有オプションを提供

### APIインターフェース

#### 充電セッション詳細取得
```
GET /api/v1/charging/session/{session_id}
```
**レスポンス:**
```json
{
  "session_id": "sess_abc123",
  "charging_id": "chrg_xyz789",
  "station": {
    "name": "きたやま関電施設",
    "address": "東京都品川区北品川5-3-1"
  },
  "start_time": "2024-02-15T19:12:00Z",
  "end_time": "2024-02-15T19:57:00Z",
  "duration_minutes": 45,
  "energy_kwh": 25.5,
  "amount": {
    "subtotal": 1400,
    "tax": 140,
    "total": 1540
  },
  "payment_method": "credit_card"
}
```

### 2. 入力状態
- **空の状態**：プレースホルダープロンプトを表示
- **入力中**：入力内容をリアルタイム表示
- **入力完了**：ボタンテキストが「発行する」に変更

### 3. エラー処理
- 特殊文字制限の通知
- 文字数制限の通知（該当する場合）
- ネットワークエラー再試行メカニズム

#### 領収書生成
```
POST /api/v1/receipts/generate
```
**リクエスト:**
```json
{
  "session_id": "sess_abc123",
  "recipient": "ABC株式会社",
  "language": "ja",
  "format": "pdf"
}
```
**レスポンス:**
```json
{
  "receipt_id": "rcpt_123456",
  "status": "generated",
  "download_url": "https://api.example.com/receipts/rcpt_123456/download",
  "expires_at": "2024-02-16T19:57:00Z",
  "metadata": {
    "receipt_number": "R20240215001",
    "issue_date": "2024-02-15",
    "verification_code": "ABCD1234"
  }
}
```

#### 領収書履歴取得
```
GET /api/v1/user/receipts
```
**クエリパラメータ:**
- `page`: 1
- `limit`: 20

**レスポンス:**
```json
{
  "total_count": 15,
  "receipts": [
    {
      "receipt_id": "rcpt_123456",
      "issue_date": "2024-02-15",
      "recipient": "ABC株式会社",
      "amount": 1540,
      "station_name": "きたやま関電施設",
      "download_url": "https://api.example.com/receipts/rcpt_123456/download"
    }
  ]
}
```

## デザイン仕様

### ビジュアルデザイン
- **背景色**：ライトグレー（#F5F5F5）
- **入力フィールド**：
  - 背景：ホワイト（#FFFFFF）
  - ボーダー：ライトグレー（#E0E0E0）
  - 角丸：8px
- **ボタン**：
  - 背景：オレンジ（#FF6B35）
  - テキスト：ホワイト（#FFFFFF）
  - 角丸：24px

### レイアウト仕様
- **コンテンツマージン**：16dp
- **要素間隔**：
  - 説明テキストから入力フィールド：24dp
  - 入力フィールドからボタン：32dp
- **入力フィールドの高さ**：48dp
- **ボタンの高さ**：48dp

### タイポグラフィ
- **説明テキスト**：
  - フォントサイズ：14sp
  - カラー：ダークグレー（#666666）
- **入力フィールドラベル**：
  - フォントサイズ：12sp
  - カラー：ミディアムグレー（#999999）
- **ボタンテキスト**：
  - フォントサイズ：16sp
  - フォントウェイト：ミディアム

## 機能拡張の検討事項

### 1. 領収書テンプレート
- よく使う宛名のプリセット
- 宛名の履歴
- クイック選択機能

### 2. 領収書フォーマット
- PDF形式でのエクスポート
- メール送信機能
- 印刷しやすいレイアウト

### 3. 情報の完全性
- 充電詳細
- 時間情報
- 金額内訳
- 税額表示

## ユーザーエクスペリエンス最適化

### 利便性
- ワンクリック発行オプション
- 履歴からのクイック入力
- 簡素化された操作フロー

### 信頼性
- 発行成功の確認
- 再発行機能
- 領収書の表示と管理

### コンプライアンス
- 財務精算要件を満たす
- 必要な法的情報を含む
- 企業の精算プロセスをサポート

## 技術実装

### データ構造
```json
{
  "recipient": "文字列",
  "amount": "数値",
  "date": "日時",
  "chargingDetails": {
    "duration": "分",
    "power": "kW",
    "location": "文字列"
  }
}
```

### 領収書生成
- サーバーサイドPDF生成
- セキュアストレージ
- ユニーク領収書ID
- 検証用QRコード

### その他のAPIインターフェース

#### よく使う宛名取得
```
GET /api/v1/user/receipt-recipients
```
**レスポンス:**
```json
{
  "recipients": [
    {
      "id": "rec_001",
      "name": "ABC株式会社",
      "usage_count": 5,
      "last_used": "2024-02-10"
    },
    {
      "id": "rec_002",
      "name": "XYZ株式会社",
      "usage_count": 3,
      "last_used": "2024-01-20"
    }
  ]
}
```

#### よく使う宛名保存
```
POST /api/v1/user/receipt-recipients
```
**リクエスト:**
```json
{
  "recipient_name": "新会社名"
}
```
**レスポンス:**
```json
{
  "id": "rec_003",
  "name": "新会社名",
  "created_at": "2024-02-15T19:57:00Z"
}
```

#### 領収書再発行
```
POST /api/v1/receipts/{receipt_id}/reissue
```
**リクエスト:**
```json
{
  "recipient": "更新された会社名"
}
```
**レスポンス:**
```json
{
  "receipt_id": "rcpt_123457",
  "original_receipt_id": "rcpt_123456",
  "status": "generated",
  "download_url": "https://api.example.com/receipts/rcpt_123457/download"
}
```